/*
 * Copyright (c) 2017 Duna Open Source Project
 * Ministério do Planejamento, Desenvolvimento de Gestão
 * República Federativa do Brasil
 *
 * This file is part of the Duna Project.
 */
plugins {
  id "us.kirchmeier.capsule" version "1.0.2"
}

group 'io.duna.example'

apply plugin: 'java'

repositories {
  mavenLocal()
  jcenter()
  maven { url 'https://dl.bintray.com/duna-project/duna/' }
}

sourceSets {
  impl
  mock
}

configurations {
  dunaAgent
  quasarAgent
}

dependencies {
//  compile 'io.duna:duna-annotations:0.3'
//  compile 'io.duna:duna-http-port-api:0.3'
  compile project(':duna-annotations')
  compile project(':duna-http-port-api')

  implCompile sourceSets.main.output
//  implCompile 'io.duna:duna-core:0.3'
//  implCompile 'io.duna:duna-cluster:0.3'
//  implCompile 'io.duna:duna-http-port:0.3'
  implCompile project(':duna-core')
  implCompile project(':duna-cluster')
  implCompile project(':duna-http-port')
  implCompile project(':duna-persistence')
  implCompile "org.hibernate:hibernate-core:5.2.6.Final"
  implCompile "org.postgresql:postgresql:9.4.1212"

  mockCompile sourceSets.main.output
//  mockCompile 'io.duna:duna-core:0.3'
//  mockCompile 'io.duna:duna-http-port:0.3'

  // Java agents
  dunaAgent project(':duna-agent')
  quasarAgent 'co.paralleluniverse:quasar-core:0.7.7:jdk8'

  testCompile group: 'junit', name: 'junit', version: '4.11'
}

compileJava {
  options.incremental = true
  options.compilerArgs = ['-parameters']
}

task run(type: JavaExec) {
  classpath sourceSets.impl.runtimeClasspath

  jvmArgs '-XX:+UseG1GC',
    '-XX:MinHeapFreeRatio=15',
    '-XX:MaxHeapFreeRatio=30',
    '-Xmx150m',
    "-javaagent:${configurations.quasarAgent.iterator().next()}=mb",
    "-javaagent:${configurations.dunaAgent.iterator().next()}",
    '-Djava.util.logging.manager=org.apache.logging.log4j.jul.LogManager'

  main = 'io.duna.core.Main'
}

task runMock(type: JavaExec) {
  classpath sourceSets.mock.runtimeClasspath

  jvmArgs '-XX:+UseG1GC',
    '-XX:MinHeapFreeRatio=15',
    '-XX:MaxHeapFreeRatio=30',
    "-javaagent:${configurations.quasarAgent.iterator().next()}=mb",
    "-javaagent:${configurations.dunaAgent.iterator().next()}",
    '-Djava.util.logging.manager=org.apache.logging.log4j.jul.LogManager'

  systemProperties['java.util.logging.manager'] = 'org.apache.logging.log4j.jul.LogManager'

  maxHeapSize '70m'

  main = 'io.duna.core.Main'
}

apply from: 'capsule.gradle'
