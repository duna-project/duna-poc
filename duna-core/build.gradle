plugins {
  id 'nebula.kotlin' version '1.0.3'
}

configurations {
  quasar
}

ext {
  byteBuddyVersion = "1.4.27"
  asmVersion = "5.1"
}

dependencies {
  compile 'io.vertx:vertx-core:3.3.3'
  compile 'io.vertx:vertx-sync:3.3.3'

  compile 'co.paralleluniverse:quasar-core:0.7.6:jdk8'
  compile 'co.paralleluniverse:quasar-kotlin:0.7.6'

  compile 'com.google.inject:guice:4.1.0'
  compile 'com.google.inject.extensions:guice-multibindings:4.1.0'

  compile "net.bytebuddy:byte-buddy:${byteBuddyVersion}"

  compile 'org.apache.logging.log4j:log4j-api:2.6.2'
  compile 'org.apache.logging.log4j:log4j-core:2.6.2'

  compile 'org.msgpack:msgpack-core:0.8.10'
  compile 'org.msgpack:jackson-dataformat-msgpack:0.8.10'

  compile 'io.github.lukehutch:fast-classpath-scanner:2.0.3'

  quasar 'co.paralleluniverse:quasar-core:0.7.6:jdk8'
}

classes {
  doFirst {
    ant.taskdef(name: 'scanSuspendables',
        classname: 'co.paralleluniverse.fibers.instrument.SuspendablesScanner',
        classpath: "build/classes/main:build/resources/main:${configurations.runtime.asPath}")
    ant.scanSuspendables(auto: false,
        suspendablesFile: "$sourceSets.main.output.resourcesDir/META-INF/suspendables",
        supersFile: "$sourceSets.main.output.resourcesDir/META-INF/suspendable-supers",
        append: true) {
      fileset(dir: sourceSets.main.output.classesDir)
    }
  }
}

tasks.withType(JavaExec) {
  jvmArgs "-javaagent:${configurations.quasar.iterator().next()}"
  jvmArgs '-XX:+UseParallelGC'
  jvmArgs '-XX:+UseCondCardMark'

  systemProperty "co.paralleluniverse.fibers.DefaultFiberPool.monitor", "JMX" // "METRICS" // "NONE" //
}

task runApp(type: JavaExec) {
  classpath = sourceSets.main.runtimeClasspath

  main = 'Test'
}